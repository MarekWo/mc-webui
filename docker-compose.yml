# mc-webui v2 â€” single container with direct device access
services:
  mc-webui:
    build: .
    container_name: mc-webui
    restart: unless-stopped
    ports:
      - "${FLASK_PORT:-5000}:${FLASK_PORT:-5000}"
    # Grant access to serial devices for auto-detection
    # Major 188 = ttyUSB (CP2102, CH340), Major 166 = ttyACM (ESP32-S3)
    device_cgroup_rules:
      - 'c 188:* rmw'
      - 'c 166:* rmw'
    volumes:
      - "${MC_CONFIG_DIR:-./data}:/data:rw"
      - "/dev:/dev"
    environment:
      - MC_SERIAL_PORT=${MC_SERIAL_PORT:-auto}
      - MC_DEVICE_NAME=${MC_DEVICE_NAME:-MeshCore}
      - MC_CONFIG_DIR=/data
      - MC_DB_PATH=/data/mc-webui.db
      # TCP mode (uncomment to use meshcore-proxy instead of serial):
      # - MC_TCP_HOST=192.168.1.100
      # - MC_TCP_PORT=5000
      - MC_BACKUP_ENABLED=${MC_BACKUP_ENABLED:-true}
      - MC_BACKUP_HOUR=${MC_BACKUP_HOUR:-2}
      - MC_BACKUP_RETENTION_DAYS=${MC_BACKUP_RETENTION_DAYS:-7}
      - FLASK_HOST=${FLASK_HOST:-0.0.0.0}
      - FLASK_PORT=${FLASK_PORT:-5000}
      - FLASK_DEBUG=${FLASK_DEBUG:-false}
      - TZ=${TZ:-UTC}
    env_file:
      - path: .env
        required: false
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
